<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Json在线解析及格式化验证 - Hijson.com</title>
    <meta name="description" content="Json中文网提供免费的JSON在线解析、格式化、验证、压缩、转XML等功能。支持JSON5语法,支持注释和尾部逗号,支持中文,支持大文件,支持本地保存。">
    <meta name="keywords" content="json解析,json格式化,json验证,json压缩,json转xml,xml转json,json在线工具,json5,json编辑器">
    <meta name="author" content="hijson.com">
    <meta name="application-name" content="HiJson">
    <meta name="apple-mobile-web-app-title" content="HiJson">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#ffffff">
    <meta property="og:title" content="Json在线解析及格式化验证 - Hijson.com">
    <meta property="og:description" content="Json中文网提供免费的JSON在线解析、格式化、验证、压缩、转XML等功能。支持JSON5语法,支持注释和尾部逗号,支持中文,支持大文件,支持本地保存。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.hijson.com">
    <meta property="og:image" content="https://www.hijson.com/images/apple-touch-icon.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Json在线解析及格式化验证 - Hijson.com">
    <meta name="twitter:description" content="Json中文网提供免费的JSON在线解析、格式化、验证、压缩、转XML等功能。支持JSON5语法,支持注释和尾部逗号,支持中文,支持大文件,支持本地保存。">
    <meta name="twitter:image" content="https://www.hijson.com/images/apple-touch-icon.png">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R3ECYJS4DW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R3ECYJS4DW');
    </script>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    
    <!-- 结构化数据 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Json在线解析工具",
        "url": "https://www.hijson.com",
        "description": "Hijson.com提供免费的JSON在线解析、格式化、验证、压缩、转XML等功能。支持JSON5语法,支持注释和尾部逗号,支持中文,支持大文件,支持本地保存。",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "CNY"
        },
        "featureList": [
            "JSON在线解析",
            "JSON格式化",
            "JSON验证",
            "JSON压缩",
            "JSON转XML",
            "XML转JSON",
            "支持JSON5语法",
            "支持注释和尾部逗号",
            "支持中文",
            "支持大文件",
            "支持本地保存"
        ]
    }
    </script>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <style>
        .toast-message {
            position: fixed;
            top: 60px;  /* 从20px改为60px，确保在语言切换器下方 */
            right: 20px;
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
        }
        .toast-message i {
            margin-right: 8px;
            color: #15b374;
        }
        .toast-message.show {
            opacity: 1;
        }
        .navi a.tip {
            /* margin-right: 8px; */
            padding: 0px 8px;
        }
        
        /* 语言选择器样式 */
        .language-selector {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 100;
        }
        
        .language-selector select {
            padding: 6px 30px 6px 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            cursor: pointer;
            color: #333;
            font-size: 13px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .language-selector select:hover {
            border-color: #ccc;
            background-color: #f8f8f8;
        }
        
        .language-selector select:focus {
            outline: none;
            border-color: #15b374;
            box-shadow: 0 0 0 3px rgba(21, 179, 116, 0.1);
        }
        
        /* 美化下拉选项 */
        .language-selector select option {
            padding: 8px;
            background-color: #fff;
            color: #333;
        }
        
        /* 适配深色模式 */
        @media (prefers-color-scheme: dark) {
            .language-selector select {
                background-color: #2d2d2d;
                border-color: #404040;
                color: #e0e0e0;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            }
            
            .language-selector select:hover {
                background-color: #353535;
                border-color: #505050;
            }
            
            .language-selector select option {
                background-color: #2d2d2d;
                color: #e0e0e0;
            }
        }
        
        /* AI修复按钮闪烁效果 */
        @keyframes glow-animation {
            0% { color: #f1592a; text-shadow: 0 0 5px rgba(241, 89, 42, 0.5); }
            50% { color: #ff8800; text-shadow: 0 0 15px rgba(255, 136, 0, 0.8), 0 0 20px rgba(255, 136, 0, 0.5); }
            100% { color: #f1592a; text-shadow: 0 0 5px rgba(241, 89, 42, 0.5); }
        }
        
        .ai-fix-glow {
            animation: glow-animation 1s infinite;
        }
        
        /* 设置AI修复图标的默认颜色 */
        .ai-fix {
            color: #15b374 !important;
        }
        
        /* 当有错误时,图标变为橙色 */
        .ai-fix.has-error {
            color: #f1592a !important;
        }
        
        /* 自适应高度设置 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .header {
            flex-shrink: 0;
        }
        
        main.row-fluid {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        main.row-fluid > div {
            height: 100%;
            position: relative;
        }
        
        #json-src {
            height: 100% !important;
        }
        
        #right-box {
            height: calc(100% - 37px) !important;
            overflow-y: auto !important;
        }
        
        /* 修复numberedtextarea相关样式 */
        .numberedtextarea-wrapper {
            height: 100% !important;
            display: flex;
            flex-direction: column;
            /* 移除任何可能导致发光的边框效果 */
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            transition: none !important;
            animation: none !important;
        }
        
        .numberedtextarea-wrapper textarea {
            flex: 1;
            height: 100% !important;
            padding-top: 12px !important;
            /* 确保输入框没有边框效果 */
            outline: none !important;
            box-shadow: none !important;
            transition: none !important;
        }
        
        .numberedtextarea-line-numbers {
            height: 100% !important;
            padding-top: 12px !important;
            /* 确保行号区域没有边框效果 */
            border: none !important;
            box-shadow: none !important;
            transition: none !important;
        }
        
        /* 覆盖jquery.numberedtextarea.css中可能存在的过渡效果 */
        .numberedtextarea-wrapper * {
            transition: none !important;
            animation: none !important;
            box-shadow: none !important;
        }
        
        /* 上传按钮样式 */
        .upload-btn {
            position: absolute;
            top: 6px;
            right: 11px;
            z-index: 100;
            background-color: #f0f0f0;
            border-radius: 3px;
            padding: 3px 6px;
            cursor: pointer;
            color: #777;
            border: 1px solid #ddd;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .upload-btn:hover {
            background-color: #e9ecef;
            color: #333;
        }
        
        .upload-btn i {
            font-size: 11px;
            margin-right: 2px;
        }
        
        /* 隐藏文件输入 */
        #file-upload {
            display: none;
        }
        
        /* 可拖动分割线样式 - 完全重写以消除任何发光效果 */
        .resizer {
            width: 6px;
            height: 100%;
            position: absolute;
            right: 0;
            top: 0;
            cursor: col-resize;
            z-index: 200;
            background: #eee;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            /* 确保没有任何可能导致发光的样式 */
            box-shadow: none !important;
            text-shadow: none !important;
            transition: none !important;
            animation: none !important;
            outline: none !important;
        }
        
        .resizer:hover {
            background-color: #ccc;
        }
        
        .resizer.dragging {
            background-color: #ccc;
        }
        
        /* 拖动时禁用文本选择 */
        body.dragging {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: col-resize !important;
        }
        
        /* 修改行号样式，移除方框 */
        div.numberedtextarea-number {
            padding-right: 6px !important;
            text-align: right !important;
            border: none !important;
            background: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            box-sizing: content-box !important;
            overflow: hidden !important;
            display: block !important;
            float: none !important;
            width: auto !important;
            height: auto !important;
            position: static !important;
            line-height: 20px !important;
        }
        
        /* 彻底移除行号的方框样式 */
        div.numberedtextarea-number,
        .numberedtextarea-line-numbers div {
            padding-right: 6px !important;
            text-align: right !important;
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            margin: 0 !important;
            font-size: inherit !important;
            line-height: 20px !important;
            display: block !important;
            color: #999 !important;
        }
        
        /* 确保内容完整显示 */
        #json-target {
            padding-bottom: 50px !important;
        }
        
        /* JSON格式化内容样式优化 */
        .ro ol.json-lines {
            margin-bottom: 50px !important;
        }
        
        .ro .json-line:last-child {
            margin-bottom: 50px !important;
        }

        .navi {
            /* display: flex; */
            align-items: center;
            margin-right: 125px; 

        .navi a {
            margin-right: 1px;
            white-space: nowrap; /* 防止文本换行 */
        }
    </style>
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Favicons -->
</head>
<body style="over-flow:hidden;">
<div class="toast-message" id="toast-message"><i class="fa fa-check-circle"></i><span id="toast-text">已复制到剪贴板</span></div>
<header class="header">
    <div class="row-fluid" >
        <div class="col-md-5" style="position:relative;">
            <a class="logo" href="index.html">hi<span style="color:#555;">json.com</span></a>

        </div>
        <nav class="col-md-7" style="position: relative; padding: 10px 0;"  align="right">
            <div  class="navi">
                <a href="index.html" data-placement="bottom">在线解析</a>
                
                <a href="wiki.html"  data-placement="bottom">什么是Json</a>
                <a href="code.html"  data-placement="bottom">Json解析代码</a>
                <a href="component.html"  data-placement="bottom">Json组件</a>

            </div>
             <div class="language-selector">
                <select id="language-select" onchange="changeLanguage(this.value)">
                    <option value="zh">中文</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="ko">한국어</option>
                </select>
            </div>
        </nav>
        <br style="clear:both;" />
    </div>
</header>


<main class="row-fluid">
    <div class="col-md-5" style="padding:0;">
        <label class="upload-btn" for="file-upload" title="上传JSON文件">
            <i class="fa fa-upload"></i> 上传
        </label>
        <input type="file" id="file-upload" accept=".json,.txt">
        <div class="form-group" style="height: 100%; margin: 0;">
            <textarea id="json-src" placeholder="在此输入json字符串或XML字符串..." class="form-control" style="height: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; resize: none; font-family: monospace; font-size: 14px; line-height: 1.4;">{
    "slogan": "智能的json在线解析工具",
    "features": [
        "支持AI智能修复",
        "支持Python字典格式",
        "支持大文件处理"
    ],
    "version": "1.0.0"
}</textarea>
        </div>
        <!-- 重新创建分割线元素，移除可能的事件和样式 -->
        <div id="divider" class="resizer"></div>
    </div>
    <div class="col-md-7" style="padding:0;">
        <div style="padding:10px;font-size:16px;" class="navi">
            <a href="index.html#" class="tip zip" title="压缩"  data-placement="bottom"><i class="fa fa-database"></i></a>
            <a href="index.html#" class="tip shown"  title="显示行号"  data-placement="bottom"><i class="glyphicon glyphicon-sort-by-order"></i></a>
            <a href="index.html#" class="tip clear" title="清空"  data-placement="bottom"><i class="fa fa-trash"></i></a>
            <a href="index.html#" class="tip undo" title="撤回"  data-placement="bottom"><i class="fa fa-undo"></i></a>
            <a href="index.html#" class="tip copy" title="复制"  data-placement="bottom"><i class="fa fa-copy"></i></a>
            <a href="index.html#" class="tip save-local" title="保存到本地"  data-placement="bottom"><i class="fa fa-download"></i></a>
            <a href="index.html#" class="tip xml" title="转XML"  data-placement="bottom"><i class="fa fa-file-code-o"></i></a>
            <a href="index.html#" class="tip py-test" title="测试Python语法"  data-placement="bottom"><i class="fa fa-flask"></i></a>
            <a href="index.html#" class="tip ai-fix" title="AI智能修复"  data-placement="bottom" style="color: #f1592a;"><i class="fa fa-magic"></i></a>
        </div>
        <div id="right-box"  style="height:679px;border-right:solid 1px #ddd;border-bottom:solid 1px #ddd;border-radius:0;resize: none;overflow-y:scroll; outline:none;position:relative;">
            <div id="line-num" style="background-color:#fafafa;padding:0px 8px;float:left;border-right:dashed 1px #eee;display:none;z-index:-1;color:#999;position:absolute;text-align:center;over-flow:hidden;">
                <div>0</div>
            </div>
            <div class="ro" id="json-target" style="padding:0px 25px 50px 25px;overflow:auto;">
            </div>
        </div>
        <form id="form-save" method="POST"><input type="hidden" value="" id="txt-content" name="content"></form>
    </div>
    <br style="clear:both;" />
</main>
<link href="css/jquery.numberedtextarea.css" rel="stylesheet">
<script src="js/jquery.min.js"></script>
<script src="js/jquery.message.js"></script>
<script src="js/jquery.json.js"></script>
<script src="js/jquery.xml2json.js"></script>
<script src="js/jquery.json2xml.js"></script>
<script src="js/json2.js"></script>
<script src="js/jsonlint.js"></script>
<script src="js/json5.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.numberedtextarea.js"></script>

<!-- 重写numberedtextarea样式以防止发光效果 -->
<style>
/* 覆盖numberedtextarea边框和过渡效果 */
div.numberedtextarea-wrapper {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    transition: none !important;
    animation: none !important;
}

div.numberedtextarea-wrapper textarea {
    border-right: solid 1px #ddd !important;
    border-left: none !important;
    border-top: none !important;
    border-bottom: solid 1px #ddd !important;
    transition: none !important;
    animation: none !important;
    box-shadow: none !important;
    outline: none !important;
}

div.numberedtextarea-line-numbers {
    border-right: 1px dashed #eee !important;
    transition: none !important;
    animation: none !important;
    box-shadow: none !important;
    outline: none !important;
}

/* 彻底移除行号的方框样式 */
div.numberedtextarea-number,
.numberedtextarea-line-numbers div {
    padding-right: 6px !important;
    text-align: right !important;
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    margin: 0 !important;
    font-size: inherit !important;
    line-height: 20px !important;
    display: block !important;
    color: #999 !important;
}

/* 确保没有任何悬停状态的过渡效果 */
div.numberedtextarea-wrapper:hover,
div.numberedtextarea-wrapper:focus,
div.numberedtextarea-wrapper:active,
div.numberedtextarea-wrapper textarea:hover,
div.numberedtextarea-wrapper textarea:focus,
div.numberedtextarea-wrapper textarea:active {
    border-color: #ddd !important;
    box-shadow: none !important;
    outline: none !important;
    transition: none !important;
}
</style>

<script type="text/javascript">
// 多语言文本定义
const i18n = {
    'zh': {  // 中文
        'navItems': {
            'onlineParse': '在线解析',
            'whatIsJson': '什么是Json',
            'parseCode': 'Json解析代码',
            'components': 'Json组件'
        },
        'upload': '上传',
        'compression': '压缩',
        'showLineNumbers': '显示行号',
        'clear': '清空',
        'undo': '撤回',
        'copy': '复制',
        'saveToLocal': '保存到本地',
        'convertToXml': '转XML',
        'testPythonSyntax': '测试Python语法',
        'aiFix': 'AI智能修复',
        'jsonParseError': 'JSON解析错误:',
        'errorHint': '提示: 检查是否有<span style="color:#f1592a;font-weight:bold;">缺失</span>的引号、逗号或括号，以及<span style="color:#f1592a;font-weight:bold;">中文</span>引号、逗号或括号。',
        'parseErrorAtLine': '解析错误，位于第 $1 行:',
        'unexpectedToken': '意外的',
        'expectedToken': '应该是',
        'endOfInput': '输入结束',
        'errorMessages': {
            'xmlConvertFailed': 'XML转换失败: $1',
            'noContentToConvert': '没有可转换的内容',
            'copyFailed': '复制失败，请手动复制',
            'noContentToSave': '没有可保存的内容',
            'noContentToUndo': '没有可撤回的内容',
            'fileTooLarge': '文件过大，请上传小于20MB的文件',
            'cannotReadFile': '无法读取文件',
            'errorReadingFile': '读取文件时发生错误',
            'noContentToFix': '没有可修复的内容',
            'cannotFix': '无法修复，请检查JSON格式'
        },
        'inputPlaceholder': '在此输入json字符串或XML字符串...'
    },
    'en': {  // 英文
        'navItems': {
            'onlineParse': 'Online Parse',
            'whatIsJson': 'What is Json',
            'parseCode': 'Parse Code',
            'components': 'Components'
        },
        'upload': 'Upload',
        'compression': 'Compress',
        'showLineNumbers': 'Show Line Numbers',
        'clear': 'Clear',
        'undo': 'Undo',
        'copy': 'Copy',
        'saveToLocal': 'Save',
        'convertToXml': 'Convert to XML',
        'testPythonSyntax': 'Test Python Syntax',
        'aiFix': 'AI Fix',
        'jsonParseError': 'JSON Parse Error:',
        'errorHint': 'Hint: Check for <span style="color:#f1592a;font-weight:bold;">missing</span> quotes, commas, or brackets.',
        'parseErrorAtLine': 'Parse error on line $1:',
        'unexpectedToken': 'Unexpected',
        'expectedToken': 'Expected',
        'endOfInput': 'end of input',
        'errorMessages': {
            'xmlConvertFailed': 'XML conversion failed: $1',
            'noContentToConvert': 'No content to convert',
            'copyFailed': 'Copy failed, please copy manually',
            'noContentToSave': 'No content to save',
            'noContentToUndo': 'No content to undo',
            'fileTooLarge': 'File too large, please upload a file smaller than 20MB',
            'cannotReadFile': 'Cannot read file',
            'errorReadingFile': 'Error reading file',
            'noContentToFix': 'No content to fix',
            'cannotFix': 'Cannot fix, please check JSON format'
        },
        'inputPlaceholder': 'Enter JSON or XML string here...'
    },
    'ja': {  // 日文
        'navItems': {
            'onlineParse': 'オンライン解析',
            'whatIsJson': 'Jsonとは',
            'parseCode': '解析コード',
            'components': 'コンポーネント'
        },
        'upload': 'アップロード',
        'compression': '圧縮',
        'showLineNumbers': '行番号の表示',
        'clear': 'クリア',
        'undo': '元に戻す',
        'copy': 'コピー',
        'saveToLocal': '保存',
        'convertToXml': 'XMLに変換',
        'testPythonSyntax': 'Python構文テスト',
        'aiFix': 'AI修正',
        'jsonParseError': 'JSON解析エラー:',
        'errorHint': 'ヒント: 引用符、カンマ、または括弧が<span style="color:#f1592a;font-weight:bold;">不足</span>していないか確認してください。',
        'parseErrorAtLine': '行$1で解析エラー:',
        'unexpectedToken': '予期しない',
        'expectedToken': '予期される',
        'endOfInput': '入力の終了',
        'errorMessages': {
            'xmlConvertFailed': 'XML変換に失敗しました: $1',
            'noContentToConvert': '変換するコンテンツがありません',
            'copyFailed': 'コピーに失敗しました、手動でコピーしてください',
            'noContentToSave': '保存するコンテンツがありません',
            'noContentToUndo': '元に戻すコンテンツがありません',
            'fileTooLarge': 'ファイルが大きすぎます、20MB未満のファイルをアップロードしてください',
            'cannotReadFile': 'ファイルを読み込めません',
            'errorReadingFile': 'ファイル読み込み中にエラーが発生しました',
            'noContentToFix': '修正するコンテンツがありません',
            'cannotFix': '修正できません、JSON形式を確認してください'
        },
        'inputPlaceholder': 'ここにJSONまたはXML文字列を入力してください...'
    },
    'ko': {  // 韩文
        'navItems': {
            'onlineParse': '온라인 파싱',
            'whatIsJson': 'Json이란',
            'parseCode': '파싱 코드',
            'components': '컴포넌트'
        },
        'upload': '업로드',
        'compression': '압축',
        'showLineNumbers': '줄 번호 표시',
        'clear': '지우기',
        'undo': '되돌리기',
        'copy': '복사',
        'saveToLocal': '저장',
        'convertToXml': 'XML로 변환',
        'testPythonSyntax': 'Python 구문 테스트',
        'aiFix': 'AI 수정',
        'jsonParseError': 'JSON 구문 오류:',
        'errorHint': '힌트: 따옴표, 쉼표 또는 괄호가 <span style="color:#f1592a;font-weight:bold;">누락</span>되었는지 확인하세요.',
        'parseErrorAtLine': '$1번 줄에서 구문 오류:',
        'unexpectedToken': '예상치 않은',
        'expectedToken': '예상된',
        'endOfInput': '입력 끝',
        'errorMessages': {
            'xmlConvertFailed': 'XML 변환 실패: $1',
            'noContentToConvert': '변환할 내용이 없습니다',
            'copyFailed': '복사 실패, 수동으로 복사하세요',
            'noContentToSave': '저장할 내용이 없습니다',
            'noContentToUndo': '되돌릴 내용이 없습니다',
            'fileTooLarge': '파일이 너무 큽니다. 20MB 미만의 파일을 업로드하세요',
            'cannotReadFile': '파일을 읽을 수 없습니다',
            'errorReadingFile': '파일 읽기 오류',
            'noContentToFix': '수정할 내용이 없습니다',
            'cannotFix': '수정할 수 없습니다. JSON 형식을 확인하세요'
        },
        'inputPlaceholder': '여기에 JSON 또는 XML 문자열을 입력하세요...'
    }
};

// 当前语言
let currentLang = 'zh';

// 切换语言方法
function changeLanguage(lang) {
    currentLang = lang;
    
    // 更新UI元素文本
    updateUIText();
    
    // 保存语言选择到localStorage
    localStorage.setItem('preferredLanguage', lang);
    
    // 如果需要，重新格式化当前JSON
    if (current_json_str && current_json_str !== '' && !xml_flag) {
        try {
            $('#json-target').html(new JSONFormat(JSON.stringify(current_json), 4).toString());
        } catch (e) {
            // 如果重新格式化失败，保持原样
        }
    }
}

// 更新UI文本
function updateUIText() {
    // 更新导航栏文本
    $('.navi a').each(function() {
        var $link = $(this);
        if ($link.attr('href') === 'index.html') {
            $link.text(i18n[currentLang].navItems.onlineParse);
        } else if ($link.attr('href') === 'wiki.html') {
            $link.text(i18n[currentLang].navItems.whatIsJson);
        } else if ($link.attr('href') === 'code.html') {
            $link.text(i18n[currentLang].navItems.parseCode);
        } else if ($link.attr('href') === 'component.html') {
            $link.text(i18n[currentLang].navItems.components);
        }
    });

    // 更新工具栏提示
    $('.zip').attr('title', i18n[currentLang].compression);
    $('.shown').attr('title', i18n[currentLang].showLineNumbers);
    $('.clear').attr('title', i18n[currentLang].clear);
    $('.undo').attr('title', i18n[currentLang].undo);
    $('.copy').attr('title', i18n[currentLang].copy);
    $('.save-local').attr('title', i18n[currentLang].saveToLocal);
    $('.xml').attr('title', i18n[currentLang].convertToXml);
    $('.py-test').attr('title', i18n[currentLang].testPythonSyntax);
    $('.ai-fix').attr('title', i18n[currentLang].aiFix);
    
    // 更新上传按钮文本
    $('.upload-btn i').next().text(i18n[currentLang].upload);
    
    // 更新输入框占位符
    $('#json-src').attr('placeholder', i18n[currentLang].inputPlaceholder);
    
    // 应用提示框以重新初始化tooltip
    $('.tip').tooltip('destroy').tooltip();
}

// 获取i18n文本
function getText(key, params) {
    let text = i18n[currentLang][key];
    
    // 如果是嵌套的错误消息
    if (key.includes('.')) {
        const parts = key.split('.');
        text = i18n[currentLang][parts[0]][parts[1]];
    }
    
    // 替换参数 ($1, $2 等)
    if (params && text) {
        params.forEach((param, index) => {
            text = text.replace('$' + (index + 1), param);
        });
    }
    
    return text || key;
}

// 显示本地化的Toast消息
function showToast(message, type) {
    var toast = $('#toast-message');
    
    // 检查是否是错误消息关键字
    if (i18n[currentLang].errorMessages && i18n[currentLang].errorMessages[message]) {
        $('#toast-text').text(i18n[currentLang].errorMessages[message]);
    } else if (message.includes(':')) {
        // 处理带有参数的消息，如 "XML转换失败: someError"
        const parts = message.split(':');
        const key = parts[0].trim();
        const param = parts[1].trim();
        
        // 查找对应的翻译
        for (const errKey in i18n[currentLang].errorMessages) {
            if (i18n[currentLang].errorMessages[errKey].includes(':')) {
                const keyBase = i18n[currentLang].errorMessages[errKey].split(':')[0].trim();
                if (keyBase === key) {
                    $('#toast-text').text(getText('errorMessages.' + errKey, [param]));
                    break;
                }
            }
        }
    } else {
        // 直接显示消息
        $('#toast-text').text(message);
    }
    
    if(type === 'error') {
        toast.find('i').removeClass('fa-check-circle fa-info-circle').addClass('fa-times-circle').css('color', '#f1592a');
    } else if(type === 'info') {
        toast.find('i').removeClass('fa-check-circle fa-times-circle').addClass('fa-info-circle').css('color', '#3498db');
    } else {
        toast.find('i').removeClass('fa-times-circle fa-info-circle').addClass('fa-check-circle').css('color', '#15b374');
    }
    
    toast.addClass('show');
    
    setTimeout(function() {
        toast.removeClass('show');
    }, 2000);
}

// 覆盖 numberedtextarea 的默认样式
(function($) {
    // 保存原始的 numberedtextarea 方法
    var originalNumberedTextarea = $.fn.numberedtextarea;
    
    // 重写 numberedtextarea 方法
    $.fn.numberedtextarea = function(options) {
        // 调用原始方法
        var result = originalNumberedTextarea.apply(this, arguments);
        
        // 立即应用无方框样式
        setTimeout(function() {
            $('div.numberedtextarea-number').css({
                'border': 'none !important',
                'background': 'none !important',
                'box-shadow': 'none !important',
                'border-radius': '0 !important',
                'margin': '0 !important',
                'padding-right': '6px !important',
                'text-align': 'right !important',
                'color': '#999 !important',
                'line-height': '20px !important'
            });
        }, 0);
        
        return result;
    };
})(jQuery);

$('textarea').numberedtextarea();
var current_json = '';
var current_json_str = '';
var last_json_src = ''; // 用于保存上一次的输入内容
var xml_flag = false;
var zip_flag = false;
var shown_flag = false;
$('.tip').tooltip();
function init(){
    xml_flag = false;
    zip_flag = false;
    shown_flag = false;
    renderLine();
    $('.xml').attr('style','color:#999;');
    $('.zip').attr('style','color:#999;');
    $('.copy').attr('style','color:#999;');
    $('.undo').attr('style','color:#999;');
    $('.ai-fix').attr('style','color:#999;');
}
$('#json-src').keyup(function(){
    // 保存当前输入，用于撤回功能
    if($(this).val() !== last_json_src) {
        last_json_src = $(this).val();
    }
    
    init();
    var content = $.trim($(this).val());
    var result = '';
    if (content!='') {
        //如果是xml,那么转换为json
        if (content.substr(0,1) === '<' && content.substr(-1,1) === '>') {
            try{
                var json_obj = $.xml2json(content);
                content = JSON.stringify(json_obj);
            }catch(e){
                result = '解析错误：<span style="color: #f1592a;font-weight:bold;">' + e.message + '</span>';
                current_json_str = result;
                $('#json-target').html(result);
                return false;
            }
        }
        try{
            // 使用更宽松的JSON5解析器
            try {
                // 首先尝试使用JSON5解析
                current_json = JSON5.parse(content);
                current_json_str = JSON.stringify(current_json);
                result = new JSONFormat(JSON.stringify(current_json), 4).toString();
            } catch(json5Error) {
                // 如果JSON5解析失败，回退到原始方法
                try {
                    // 不再删除换行符，保留原始行号信息
            current_json = jsonlint.parse(content);
            current_json_str = JSON.stringify(current_json);
                    result = new JSONFormat(content, 4).toString();
                } catch(e) {
                    throw {
                        message: e.toString(),
                        original: content
                    };
                }
            }
        } catch(e) {
            // 优化错误提示
            var errorMsg = e.message || e.toString();
            var originalContent = e.original || content;
            
            // 在解析错误时让AI修复按钮闪烁发光并添加错误类
            $('.ai-fix').addClass('ai-fix-glow has-error');
            // 6秒后停止闪烁,但保持错误状态
            setTimeout(function() {
                $('.ai-fix').removeClass('ai-fix-glow');
            }, 6000);
            
            // 尝试定位错误位置
            var errorLineInfo = '';
            var match = errorMsg.match(/line\s+(\d+)/i) || errorMsg.match(/在第(\d+)行/);
            if (match && match[1]) {
                var lineNum = parseInt(match[1]);
                var contentLines = originalContent.split("\n");
                var errorLine = contentLines[lineNum - 1] || '';
                
                if (errorLine) {
                    // 不再重复显示行号，直接显示有问题的行内容
                    errorLineInfo = '<div style="margin-top:10px;background:#ffecec;padding:10px;border-radius:4px;border-left:4px solid #f1592a;">' +
                        '<pre style="margin:0;white-space:pre-wrap;word-break:break-all;">' + 
                        escapeHtml(errorLine) + '</pre></div>';
                }
            }
            
            // 美化错误信息
            var friendlyError = errorMsg
                .replace(/Parse error on line (\d+):/g, getText('parseErrorAtLine', [match ? match[1] : ""]))
                .replace(/Unexpected/g, getText('unexpectedToken'))
                .replace(/Expected/g, getText('expectedToken'))
                .replace(/\s?'([^']+)'\s?/g, ' <code>$1</code> ')
                .replace(/\[\d+,\s*\d+\]/g, '')  // 移除位置信息 [1, 2] 这样的内容
                .replace(/end of input/g, getText('endOfInput'));
            
            result = '<div style="color: #f1592a;font-weight:bold;">' + 
                '<i class="fa fa-exclamation-circle" style="margin-right:5px;"></i>' + getText('jsonParseError') + '<div style="margin:10px 0 0 10px;">' + 
                friendlyError + '</div>' + errorLineInfo + 
                '<div style="margin-top:15px;font-weight:normal;color:#666;">' + 
                getText('errorHint') + 
                '</div></div>';
            
            current_json_str = result;
        }

        $('#json-target').html(result);
        
        // 确保内容底部有足够空间
        ensureBottomSpaceForJson();
    }else{
        $('#json-target').html('');
    }

});
$('.xml').click(function(){
    if(current_json_str && current_json_str !== '') {
    if (xml_flag) {
            // 如果已经是XML模式，切换回JSON
        $('#json-src').keyup();
            $(this).attr('style','color:#999;');
        } else {
            // 转换为XML并显示
            try {
                var xmlString = $.json2xml(current_json);
                // 美化XML
                var formattedXml = formatXml(xmlString);
                $('#json-target').html('<pre style="padding:10px;white-space:pre-wrap;word-wrap:break-word;">' + escapeHtml(formattedXml) + '</pre>');
        xml_flag = true;
        $(this).attr('style','color:#15b374;');
            } catch (e) {
                showToast(getText('errorMessages.xmlConvertFailed', [e.message]), 'error');
    }
        }
    } else {
        showToast(getText('errorMessages.noContentToConvert'), 'error');
    }
});
$('.shown').click(function(){
    if (!shown_flag) {
        renderLine();
        $('#json-src').attr("style","height:722px;padding:0 10px 10px 40px;border:0;border-right:solid 1px #ddd;border-bottom:solid 1px #ddd;border-radius:0;resize: none; outline:none;");
        $('#json-target').attr("style","padding:0px 50px;");
        $('#line-num').show();
        $('.numberedtextarea-line-numbers').show();
        
        // 应用自定义样式到行号
        applyLineNumberStyles();
        
        shown_flag = true;
        $(this).attr('style','color:#15b374;');
    }else{
        $('#json-src').attr("style","height:722px;padding:0 10px 10px 20px;border:0;border-right:solid 1px #ddd;border-bottom:solid 1px #ddd;border-radius:0;resize: none; outline:none;");
        $('#json-target').attr("style","padding:0px 20px;");
        $('#line-num').hide();
        $('.numberedtextarea-line-numbers').hide();
        shown_flag = false;
        $(this).attr('style','color:#999;');
    }
});

// 应用自定义样式到行号
function applyLineNumberStyles() {
    // 移除行号的方框样式
    $('.numberedtextarea-number, .numberedtextarea-line-numbers div').css({
        'border': 'none',
        'background': 'transparent',
        'box-shadow': 'none',
        'border-radius': '0',
        'margin': '0',
        'padding-right': '6px',
        'text-align': 'right',
        'color': '#999',
        'line-height': '20px'
    });
}

function renderLine(){
    var line_num = $('#json-target').height()/20;
    $('#line-num').html("");
    var line_num_html = "";
    for (var i = 1; i < line_num+1; i++) {
        line_num_html += "<div>"+i+"<div>";
    }
    $('#line-num').html(line_num_html);
}
$('.zip').click(function(){
    if (zip_flag) {
        $('#json-src').keyup();
    }else{
        $('#json-target').html(current_json_str);
        zip_flag = true;
        $(this).attr('style','color:#15b374;');
    }

});
$('.clear').click(function(){
     // 保存当前值用于撤回
     if($('#json-src').val() !== '') {
         last_json_src = $('#json-src').val();
         $('.undo').attr('style','color:#15b374;');
     }
     
     $('#json-src').val('');
     $('#json-target').html('');
     // 移除成功清空提示
     // showToast('已清空内容');
});
$('.copy').click(function(){
    if(current_json_str && current_json_str !== '') {
        var tempTextarea = document.createElement('textarea');
        var contentToCopy = '';
        
        if (xml_flag) {
            // 如果当前是XML模式，复制XML内容
            var xmlString = $.json2xml(current_json);
            contentToCopy = formatXml(xmlString);
        } else {
            // 否则复制JSON内容
            contentToCopy = zip_flag ? current_json_str : JSON.stringify(current_json, null, 4);
        }
        
        tempTextarea.value = contentToCopy;
        tempTextarea.style.position = 'absolute';
        tempTextarea.style.left = '-9999px';
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        var successful = document.execCommand('copy');
        document.body.removeChild(tempTextarea);
        
        if(successful) {
            // 保留复制成功提示
            showToast(xml_flag ? '已复制XML内容' : '已复制JSON内容');
            $(this).attr('style','color:#15b374;');
            setTimeout(function() {
                $('.copy').attr('style','color:#999;');
            }, 1000);
        } else {
            showToast(getText('errorMessages.copyFailed'), 'error');
        }
    }
});

// 保存到本地功能
$('.save-local').click(function(){
    if(current_json_str && current_json_str !== '') {
        // 确定文件内容和类型
        var content = '';
        var fileType = '';
        var fileName = '';
        
        // 生成基于时间戳和内容的文件名
        var timestamp = new Date().getTime();
        var hashBase = timestamp + (Math.random().toString(36).substring(2, 8));
        var fileNameBase = md5(hashBase).substring(0, 8) + '_' + timestamp;
        
        if (xml_flag) {
            // 如果当前是XML模式，保存XML内容
            var xmlString = $.json2xml(current_json);
            content = formatXml(xmlString);
            fileType = 'application/xml';
            fileName = fileNameBase + '.xml';
        } else {
            // 否则保存JSON内容
            content = zip_flag ? current_json_str : JSON.stringify(current_json, null, 4);
            fileType = 'application/json';
            fileName = fileNameBase + '.json';
        }
        
        // 创建Blob对象
        var blob = new Blob([content], {type: fileType});
        
        // 创建下载链接
        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = fileName;
        
        // 添加到文档并触发点击
        document.body.appendChild(link);
        link.click();
        
        // 清理DOM
        document.body.removeChild(link);
        window.URL.revokeObjectURL(link.href);
        
        // 显示提示并改变按钮颜色
        // showToast(xml_flag ? 'XML已保存到本地' : 'JSON已保存到本地');
        $(this).attr('style','color:#15b374;');
        setTimeout(function() {
            $('.save-local').attr('style','color:#999;');
        }, 1000);
    } else {
        showToast(getText('errorMessages.noContentToSave'), 'error');
    }
});

// MD5哈希函数
function md5(string) {
    function md5cycle(x, k) {
        var a = x[0], b = x[1], c = x[2], d = x[3];
        
        a = ff(a, b, c, d, k[0], 7, -680876936);
        d = ff(d, a, b, c, k[1], 12, -389564586);
        c = ff(c, d, a, b, k[2], 17, 606105819);
        b = ff(b, c, d, a, k[3], 22, -1044525330);
        a = ff(a, b, c, d, k[4], 7, -176418897);
        d = ff(d, a, b, c, k[5], 12, 1200080426);
        c = ff(c, d, a, b, k[6], 17, -1473231341);
        b = ff(b, c, d, a, k[7], 22, -45705983);
        a = ff(a, b, c, d, k[8], 7, 1770035416);
        d = ff(d, a, b, c, k[9], 12, -1958414417);
        c = ff(c, d, a, b, k[10], 17, -42063);
        b = ff(b, c, d, a, k[11], 22, -1990404162);
        a = ff(a, b, c, d, k[12], 7, 1804603682);
        d = ff(d, a, b, c, k[13], 12, -40341101);
        c = ff(c, d, a, b, k[14], 17, -1502002290);
        b = ff(b, c, d, a, k[15], 22, 1236535329);
        
        a = gg(a, b, c, d, k[1], 5, -165796510);
        d = gg(d, a, b, c, k[6], 9, -1069501632);
        c = gg(c, d, a, b, k[11], 14, 643717713);
        b = gg(b, c, d, a, k[0], 20, -373897302);
        a = gg(a, b, c, d, k[5], 5, -701558691);
        d = gg(d, a, b, c, k[10], 9, 38016083);
        c = gg(c, d, a, b, k[15], 14, -660478335);
        b = gg(b, c, d, a, k[4], 20, -405537848);
        a = gg(a, b, c, d, k[9], 5, 568446438);
        d = gg(d, a, b, c, k[14], 9, -1019803690);
        c = gg(c, d, a, b, k[3], 14, -187363961);
        b = gg(b, c, d, a, k[8], 20, 1163531501);
        a = gg(a, b, c, d, k[13], 5, -1444681467);
        d = gg(d, a, b, c, k[2], 9, -51403784);
        c = gg(c, d, a, b, k[7], 14, 1735328473);
        b = gg(b, c, d, a, k[12], 20, -1926607734);
        
        a = hh(a, b, c, d, k[5], 4, -378558);
        d = hh(d, a, b, c, k[8], 11, -2022574463);
        c = hh(c, d, a, b, k[11], 16, 1839030562);
        b = hh(b, c, d, a, k[14], 23, -35309556);
        a = hh(a, b, c, d, k[1], 4, -1530992060);
        d = hh(d, a, b, c, k[4], 11, 1272893353);
        c = hh(c, d, a, b, k[7], 16, -155497632);
        b = hh(b, c, d, a, k[10], 23, -1094730640);
        a = hh(a, b, c, d, k[13], 4, 681279174);
        d = hh(d, a, b, c, k[0], 11, -358537222);
        c = hh(c, d, a, b, k[3], 16, -722521979);
        b = hh(b, c, d, a, k[6], 23, 76029189);
        a = hh(a, b, c, d, k[9], 4, -640364487);
        d = hh(d, a, b, c, k[12], 11, -421815835);
        c = hh(c, d, a, b, k[15], 16, 530742520);
        b = hh(b, c, d, a, k[2], 23, -995338651);
        
        a = ii(a, b, c, d, k[0], 6, -198630844);
        d = ii(d, a, b, c, k[7], 10, 1126891415);
        c = ii(c, d, a, b, k[14], 15, -1416354905);
        b = ii(b, c, d, a, k[5], 21, -57434055);
        a = ii(a, b, c, d, k[12], 6, 1700485571);
        d = ii(d, a, b, c, k[3], 10, -1894986606);
        c = ii(c, d, a, b, k[10], 15, -1051523);
        b = ii(b, c, d, a, k[1], 21, -2054922799);
        a = ii(a, b, c, d, k[8], 6, 1873313359);
        d = ii(d, a, b, c, k[15], 10, -30611744);
        c = ii(c, d, a, b, k[6], 15, -1560198380);
        b = ii(b, c, d, a, k[13], 21, 1309151649);
        a = ii(a, b, c, d, k[4], 6, -145523070);
        d = ii(d, a, b, c, k[11], 10, -1120210379);
        c = ii(c, d, a, b, k[2], 15, 718787259);
        b = ii(b, c, d, a, k[9], 21, -343485551);
        
        x[0] = add32(a, x[0]);
        x[1] = add32(b, x[1]);
        x[2] = add32(c, x[2]);
        x[3] = add32(d, x[3]);
    }
    
    function cmn(q, a, b, x, s, t) {
        a = add32(add32(a, q), add32(x, t));
        return add32((a << s) | (a >>> (32 - s)), b);
    }
    
    function ff(a, b, c, d, x, s, t) {
        return cmn((b & c) | ((~b) & d), a, b, x, s, t);
    }
    
    function gg(a, b, c, d, x, s, t) {
        return cmn((b & d) | (c & (~d)), a, b, x, s, t);
    }
    
    function hh(a, b, c, d, x, s, t) {
        return cmn(b ^ c ^ d, a, b, x, s, t);
    }
    
    function ii(a, b, c, d, x, s, t) {
        return cmn(c ^ (b | (~d)), a, b, x, s, t);
    }
    
    function md51(s) {
        var n = s.length,
        state = [1732584193, -271733879, -1732584194, 271733878], i;
        for (i = 64; i <= s.length; i += 64) {
            md5cycle(state, md5blk(s.substring(i - 64, i)));
        }
        s = s.substring(i - 64);
        var tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        for (i = 0; i < s.length; i++)
            tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);
        tail[i >> 2] |= 0x80 << ((i % 4) << 3);
        if (i > 55) {
            md5cycle(state, tail);
            for (i = 0; i < 16; i++) tail[i] = 0;
        }
        tail[14] = n * 8;
        md5cycle(state, tail);
        return state;
    }
    
    function md5blk(s) {
        var md5blks = [], i;
        for (i = 0; i < 64; i += 4) {
            md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);
        }
        return md5blks;
    }
    
    var hex_chr = '0123456789abcdef'.split('');
    
    function rhex(n) {
        var s = '', j = 0;
        for (; j < 4; j++)
            s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
        return s;
    }
    
    function hex(x) {
        for (var i = 0; i < x.length; i++)
            x[i] = rhex(x[i]);
        return x.join('');
    }
    
    function add32(a, b) {
        return (a + b) & 0xFFFFFFFF;
    }
    
    return hex(md51(string));
}

function showToast(message, type) {
    var toast = $('#toast-message');
    $('#toast-text').text(message);
    
    if(type === 'error') {
        toast.find('i').removeClass('fa-check-circle fa-info-circle').addClass('fa-times-circle').css('color', '#f1592a');
    } else if(type === 'info') {
        toast.find('i').removeClass('fa-check-circle fa-times-circle').addClass('fa-info-circle').css('color', '#3498db');
    } else {
        toast.find('i').removeClass('fa-times-circle fa-info-circle').addClass('fa-check-circle').css('color', '#15b374');
    }
    
    toast.addClass('show');
    
    setTimeout(function() {
        toast.removeClass('show');
    }, 2000);
}

$('.save').click(function(){
    var content = JSON.stringify(current_json);
    $('#txt-content').val(content);
    $("#form-save").submit();
});

$('.undo').click(function(){
    if(last_json_src !== '') {
        $('#json-src').val(last_json_src);
        $('#json-src').keyup(); // 触发解析
        // 移除恢复成功提示
        // showToast('已恢复上次内容');
        $(this).attr('style','color:#999;');
    } else {
        showToast('没有可撤回的内容', 'error');
    }
});

// 格式化XML
function formatXml(xml) {
    var formatted = '';
    var reg = /(>)(<)(\/*)/g;
    xml = xml.replace(reg, '$1\r\n$2$3');
    var pad = 0;
    
    xml.split('\r\n').forEach(function(node) {
        var indent = 0;
        if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
        } else if (node.match(/^<\/\w/)) {
            if (pad != 0) pad -= 1;
        } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
        } else {
            indent = 0;
        }

        var padding = '';
        for (var i = 0; i < pad; i++) {
            padding += '  ';
        }

        formatted += padding + node + '\r\n';
        pad += indent;
    });

    return formatted;
}

// 转义HTML标签
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// 防止点击输入框导致分割线突出
$('#json-src').on('click focus', function(e) {
    // 阻止事件冒泡
    e.stopPropagation();
});

// 页面加载完成后自动触发解析和调整高度
$(document).ready(function() {
    // 触发解析默认JSON示例
$('#json-src').keyup();
    
    // 强制移除numberedtextarea的所有可能导致闪烁的样式
    function fixNumberedTextarea() {
        // 移除所有可能的过渡效果
        $('.numberedtextarea-wrapper, .numberedtextarea-wrapper *, div.numberedtextarea-line-numbers, div.numberedtextarea-wrapper textarea').css({
            'transition': 'none',
            'animation': 'none',
            'box-shadow': 'none',
            'text-shadow': 'none',
            'border-style': 'solid',
            'outline': 'none'
        });
        
        // 确保文本区域边框设置正确
        $('.numberedtextarea-wrapper textarea').css({
            'border-right': 'solid 1px #ddd',
            'border-left': 'none',
            'border-top': 'none',
            'border-bottom': 'solid 1px #ddd'
        });
        
        // 确保行号区域边框设置正确
        $('.numberedtextarea-line-numbers').css({
            'border-right': '1px dashed #eee',
            'border': 'none',
            'box-shadow': 'none'
        });
        
        // 应用行号样式
        applyLineNumberStyles();
    }
    
    // 初始应用一次
    fixNumberedTextarea();
    
    // 定期检查和修复（防止动态变化）
    setInterval(fixNumberedTextarea, 200);
    
    // 在任何用户交互后都重新应用样式修复
    $(document).on('click keyup focus blur', function() {
        fixNumberedTextarea();
    });
    
    // 特别强制应用行号样式
    setTimeout(applyLineNumberStyles, 500);
    setTimeout(applyLineNumberStyles, 1000);
    
    // 调整高度以适应窗口
    function adjustHeight() {
        var windowHeight = $(window).height();
        var headerHeight = $('.header').outerHeight();
        $('main.row-fluid').css('height', (windowHeight - headerHeight) + 'px');
        
        // 确保numberedtextarea-wrapper也有正确的高度
        $('.numberedtextarea-wrapper').css('height', '100%');
        $('.numberedtextarea-wrapper textarea').css('height', '100%');
        $('.numberedtextarea-line-numbers').css('height', '100%');
        
        // 调整右侧内容区域高度
        var rightNavHeight = $('.navi').outerHeight();
        $('#right-box').css('height', 'calc(100% - ' + rightNavHeight + 'px)');
        
        // 确保内容容器有足够的空间
        $('#json-target').css('min-height', 'calc(100% - 10px)');
    }
    
    // 初始调整和窗口大小变化时调整
    adjustHeight();
    $(window).resize(adjustHeight);
    
    // 文件上传处理
    $('#file-upload').change(function(e) {
        if (e.target.files.length > 0) {
            var file = e.target.files[0];
            
            // 检查文件大小，限制在20MB以内
            if (file.size > 20 * 1024 * 1024) {
                showToast('文件过大，请上传小于20MB的文件', 'error');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(event) {
                try {
                    var content = event.target.result;
                    $('#json-src').val(content);
                    $('#json-src').keyup(); // 触发解析
                } catch (err) {
                    showToast('无法读取文件', 'error');
                }
            };
            reader.onerror = function() {
                showToast('读取文件时发生错误', 'error');
            };
            reader.readAsText(file);
        }
    });
    
    // 完全重置分割线的风格和行为
    (function initDivider() {
        var $leftPanel = $('.col-md-5');
        var $rightPanel = $('.col-md-7');
        var $mainContainer = $('main.row-fluid');
        var $divider = $('#divider');
        var isDragging = false;
        var startX, startLeftWidth;
        
        // 移除任何可能残留的事件监听器
        $divider.off();
        
        // 确保分割线样式纯净
        $divider.css({
            'width': '6px',
            'height': '100%',
            'position': 'absolute',
            'right': '0',
            'top': '0',
            'cursor': 'col-resize',
            'z-index': '200',
            'background': '#eee',
            'border-left': '1px solid #ddd',
            'border-right': '1px solid #ddd',
            'box-shadow': 'none',
            'transition': 'none',
            'animation': 'none',
            'text-shadow': 'none'
        });
        
        // 重新绑定事件
        $divider.on('mousedown', function(e) {
            isDragging = true;
            startX = e.pageX;
            startLeftWidth = $leftPanel.width();
            
            $divider.css('background-color', '#ccc');
            $('body').addClass('dragging');
            
            e.preventDefault();
            e.stopPropagation();
        });
        
        $(document).on('mousemove', function(e) {
            if (!isDragging) return;
            
            var mainWidth = $mainContainer.width();
            var newLeftWidth = startLeftWidth + (e.pageX - startX);
            
            // 限制最小宽度
            if (newLeftWidth < 200) newLeftWidth = 200;
            if (mainWidth - newLeftWidth < 200) newLeftWidth = mainWidth - 200;
            
            // 计算百分比
            var leftPercent = (newLeftWidth / mainWidth) * 100;
            var rightPercent = 100 - leftPercent;
            
            // 设置新宽度
            $leftPanel.css('width', leftPercent + '%');
            $rightPanel.css('width', rightPercent + '%');
            
            // 触发窗口调整事件以重新计算各元素大小
            $(window).trigger('resize');
        });
        
        $(document).on('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                $divider.css('background-color', '#eee');
                $('body').removeClass('dragging');
            }
        });
        
        // 阻止文本输入框的点击和聚焦事件传播
        $('#json-src').on('click focus', function(e) {
            e.stopPropagation();
        });
    })();
    
    // 获取保存的语言设置并初始化
    // 检查localStorage中是否有语言设置
    const savedLang = localStorage.getItem('preferredLanguage');
    if (savedLang && i18n[savedLang]) {
        currentLang = savedLang;
        $('#language-select').val(savedLang);
    } else {
        // 如果没有保存的设置，尝试检测浏览器语言
        const browserLang = navigator.language || navigator.userLanguage;
        const shortLang = browserLang.split('-')[0]; // 获取主要语言代码，如zh-CN变为zh
        
        if (i18n[shortLang]) {
            currentLang = shortLang;
            $('#language-select').val(shortLang);
        }
    }
    
    // 初始化UI文本
    updateUIText();
});

$('.ai-fix').click(function(){
    var content = $.trim($('#json-src').val());
    if(content == '') {
        showToast('没有可修复的内容', 'error');
        return;
    }
    
    // 停止闪烁效果
    $('.ai-fix').removeClass('ai-fix-glow');
    
    // 尝试智能修复JSON
    var fixedJson = aiFixJson(content);
    
    if(fixedJson !== null) {
        // 如果修复成功，更新输入区域
        $('#json-src').val(fixedJson);
        // 触发解析
        $('#json-src').keyup();
        // 保留修复成功提示
        showToast('AI修复成功', 'success');
        $(this).attr('style','color:#15b374;');
        // 移除错误类
        $('.ai-fix').removeClass('has-error');
        setTimeout(function() {
            $('.ai-fix').attr('style','color:#999;');
        }, 1500);
    } else {
        showToast(getText('errorMessages.cannotFix'), 'error');
    }
});

// Python语法测试功能
$('.py-test').click(function(){
    // 设置Python样式的测试用例
    var pythonTestCase = `{
    "simple": True,
    "nested": {
        "value": False,
        "another": {
            "deepNested": True
        }
    },
    "string_with_keywords": "This is a True story about False events",
    "list_with_booleans": [True, False, None, "True in quotes"],
    "object_with_booleans": {
        "key1": True,
        "key2": False,
        "nested": {
            "key3": True,
            "text": "Contains True and False"
        }
    },
    "none_value": None
}`;

    // 设置到输入框
    $('#json-src').val(pythonTestCase);
    
    // 触发AI修复
    $('.ai-fix').click();
    
    // 高亮测试按钮
    $(this).attr('style','color:#15b374;');
    setTimeout(function() {
        $('.py-test').attr('style','color:#999;');
    }, 1500);
});

// AI修复JSON函数
function aiFixJson(content) {
    try {
        // 先尝试标准解析，如果成功就不需要修复
        try {
            JSON5.parse(content);
            return content; // 已经是有效的JSON5
        } catch (e) {
            // 继续下面的修复流程
        }
        
        // 创建标记字典来跟踪哪些位置是字符串
        var inString = false;
        var stringChar = '';
        var isEscaped = false;
        var stringPositions = [];
        
        // 遍历字符串，标记所有字符串内部的位置
        for (var i = 0; i < content.length; i++) {
            var char = content[i];
            
            if (isEscaped) {
                isEscaped = false;
                continue;
            }
            
            if (char === '\\') {
                isEscaped = true;
                continue;
            }
            
            if (inString) {
                stringPositions[i] = true;
                if (char === stringChar) {
                    inString = false;
                }
            } else if (char === '"' || char === "'") {
                inString = true;
                stringChar = char;
                stringPositions[i] = true; // 引号自身也标记为字符串的一部分
            }
        }
        
        // 0. 预处理 - 处理Python特殊值和语法
        
        // 更精确地处理Python的布尔值和None
        var fixedContent = '';
        var tokens = content.split(/(\b(?:True|False|None)\b)/g);
        
        for (var i = 0; i < tokens.length; i++) {
            var token = tokens[i];
            
            if (token === 'True' || token === 'False' || token === 'None') {
                // 检查当前token的第一个字符在原始字符串中的位置是否在字符串内
                var tokenStartPos = content.indexOf(token, fixedContent.length);
                var isInString = stringPositions[tokenStartPos] === true;
                
                if (!isInString) {
                    // 只有不在字符串内才替换
                    if (token === 'True') token = 'true';
                    else if (token === 'False') token = 'false';
                    else if (token === 'None') token = 'null';
                }
            }
            
            fixedContent += token;
        }
        
        content = fixedContent;
        
        // 转义字符串中的URL特殊字符
        content = escapeUrlSpecialCharsInJson(content);
        
        // 其他处理保持不变
        content = content
            // 处理Python的元组和集合 - 替换为数组
            .replace(/\(([^)]*)\)/g, function(match, p1) {
                // 仅替换看起来像元组的部分
                if (/^\s*[\w\d"'\[\]\{\},\s:]+\s*$/.test(p1)) {
                    return '[' + p1 + ']';
                }
                return match;
            })
            // 转换集合语法为数组
            .replace(/\{([^{}]*)\}/g, function(match, p1) {
                // 仅当内容不包含键值对（:）时才替换，避免替换对象
                if (p1.indexOf(':') === -1) {
                    return '[' + p1 + ']';
                }
                return match;
            })
            // 移除Python注释
            .replace(/#.*$/gm, '')
            // 处理多行字符串
            .replace(/'''([\s\S]*?)'''/g, function(match, p1) {
                return JSON.stringify(p1);
            })
            .replace(/"""([\s\S]*?)"""/g, function(match, p1) {
                return JSON.stringify(p1);
            })
            // 处理字符串中的单引号
            .replace(/'([^']*)'/g, function(match, p1) {
                // 如果已经在双引号内，不进行替换
                if (isInDoubleQuotes(content, match.index)) {
                    return match;
                }
                return '"' + p1.replace(/"/g, '\\"') + '"';
            })
            // 处理Python的数学表示法（1e6这类）
            .replace(/\b(\d+)e([+-]?\d+)\b/g, function(match, p1, p2) {
                return p1 + 'e' + p2;
            });
        
        // 1. 尝试处理前后有日志信息的情况
        var jsonPattern = /(\{[\s\S]*\}|\[[\s\S]*\])/;
        var matches = content.match(jsonPattern);
        
        if (matches && matches[1]) {
            var extractedJson = matches[1];
            try {
                JSON5.parse(extractedJson);
                return extractedJson; // 提取的内容是有效JSON
            } catch (e) {
                // 提取的内容还不是有效JSON，继续修复
            }
        }
        
        // 2. 检查并修复缺失的大括号和中括号
        var openCurly = (content.match(/\{/g) || []).length;
        var closeCurly = (content.match(/\}/g) || []).length;
        var openSquare = (content.match(/\[/g) || []).length;
        var closeSquare = (content.match(/\]/g) || []).length;
        
        // 检查是否缺少开头的大括号或中括号
        var firstChar = content.trim().charAt(0);
        var lastChar = content.trim().charAt(content.trim().length - 1);
        var needOpeningCurly = false;
        var needOpeningSquare = false;
        
        // 如果内容的第一个非空字符不是{或[，但是存在}或]，则可能需要添加开头括号
        if (firstChar !== '{' && firstChar !== '[') {
            // 如果有闭合括号，判断需要哪种开头括号
            if (closeCurly > openCurly) {
                needOpeningCurly = true;
            } else if (closeSquare > openSquare) {
                needOpeningSquare = true;
            }
            // 如果没有明显的括号不平衡，但内容像是一个对象
            else if (content.includes(':') && !content.trim().startsWith('"') && !content.trim().startsWith("'")) {
                needOpeningCurly = true;
            }
            // 如果看起来像是一个数组
            else if (content.includes(',') && !content.includes(':')) {
                needOpeningSquare = true;
            }
        }
        
        // 添加缺失的开头括号
        if (needOpeningCurly) {
            content = '{' + content;
            openCurly++; // 更新括号计数
        } else if (needOpeningSquare) {
            content = '[' + content;
            openSquare++; // 更新括号计数
        }
        
        // 如果内容不以{或[开头，但包含它们，尝试找到第一个有效位置
        if (!/^[\s]*[\{\[]/.test(content) && (openCurly > 0 || openSquare > 0)) {
            var firstCurly = content.indexOf('{');
            var firstSquare = content.indexOf('[');
            
            if (firstCurly >= 0 && (firstSquare < 0 || firstCurly < firstSquare)) {
                content = content.substring(firstCurly);
            } else if (firstSquare >= 0) {
                content = content.substring(firstSquare);
            }
        }
        
        // 补全缺失的闭合大括号
        if (openCurly > closeCurly) {
            for (var i = 0; i < openCurly - closeCurly; i++) {
                content += '}';
            }
        }
        // 补全缺失的开头大括号（如果结尾有多余）
        else if (closeCurly > openCurly) {
            content = '{' + content;
            // 如果添加了开头括号但仍然不平衡，继续添加
            for (var i = 1; i < closeCurly - openCurly; i++) {
                content = '{' + content;
            }
        }
        
        // 补全缺失的闭合中括号
        if (openSquare > closeSquare) {
            for (var i = 0; i < openSquare - closeSquare; i++) {
                content += ']';
            }
        }
        // 补全缺失的开头中括号（如果结尾有多余）
        else if (closeSquare > openSquare) {
            content = '[' + content;
            // 如果添加了开头括号但仍然不平衡，继续添加
            for (var i = 1; i < closeSquare - openSquare; i++) {
                content = '[' + content;
            }
        }
        
        // 3. 尝试处理常见语法错误
        // 移除行尾多余的逗号（JSON5已经支持，这里作为额外保障）
        content = content.replace(/,(\s*[\}\]])/g, '$1');
        
        // 修复未闭合的引号
        var fixedContent = fixUnclosedQuotes(content);
        
        // 最终验证
        try {
            JSON5.parse(fixedContent);
            return fixedContent;
        } catch (e) {
            // 如果还是失败，最后尝试一种更激进的方式
            try {
                // 检查是否像是一个对象但没有括号
                if (!fixedContent.trim().startsWith('{') && !fixedContent.trim().startsWith('[') &&
                    fixedContent.includes(':')) {
                    fixedContent = '{' + fixedContent + '}';
                    // 再次尝试解析
                    try {
                        JSON5.parse(fixedContent);
                        return fixedContent;
                    } catch (err) {
                        // 继续下面的尝试
                    }
                }
                
                // 尝试通过eval方式转换（仅用于修复，有潜在安全风险）
                // 因为某些情况下，字符串中包含特殊字符或不规范的内容可能导致解析失败
                var obj = eval('(' + fixedContent + ')');
                return JSON.stringify(obj, null, 2);
            } catch (evalError) {
                // 如果所有方法都失败，最后一次尝试：
                // 直接加上大括号包装整个内容
                try {
                    if (!fixedContent.trim().startsWith('{') && !fixedContent.trim().startsWith('[')) {
                        fixedContent = '{' + fixedContent + '}';
                        JSON5.parse(fixedContent);
                        return fixedContent;
                    }
                } catch (finalError) {
                    // 如果所有方法都失败，返回null
                    return null;
                }
                return null;
            }
        }
    } catch (e) {
        console.error('AI修复过程发生错误:', e);
        return null;
    }
}

// 辅助函数：检查字符串某位置是否在双引号内
function isInDoubleQuotes(str, pos) {
    var quoteCount = 0;
    for (var i = 0; i < pos; i++) {
        if (str[i] === '"' && (i === 0 || str[i-1] !== '\\')) {
            quoteCount++;
        }
    }
    return quoteCount % 2 === 1; // 奇数表示在引号内
}

// 修复未闭合的引号
function fixUnclosedQuotes(content) {
    // 这里实现一个简单的引号修复逻辑
    var lines = content.split('\n');
    var inString = false;
    var quoteChar = '';
    
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var newLine = '';
        
        for (var j = 0; j < line.length; j++) {
            var char = line[j];
            newLine += char;
            
            if ((char === '"' || char === "'") && (j === 0 || line[j-1] !== '\\')) {
                if (!inString) {
                    inString = true;
                    quoteChar = char;
                } else if (char === quoteChar) {
                    inString = false;
                }
            }
        }
        
        // 如果这一行结束时还在字符串内，添加结束引号
        if (inString) {
            newLine += quoteChar;
            inString = false;
        }
        
        lines[i] = newLine;
    }
    
    return lines.join('\n');
}

// 转义JSON字符串中的URL特殊字符
function escapeUrlSpecialCharsInJson(content) {
    // 创建一个处理字符串的函数，只处理字符串内部的特殊字符
    var inString = false;
    var stringChar = '';
    var isEscaped = false;
    var result = '';
    
    for (var i = 0; i < content.length; i++) {
        var char = content[i];
        
        if (isEscaped) {
            // 已经是转义字符，直接添加
            result += char;
            isEscaped = false;
            continue;
        }
        
        if (char === '\\') {
            // 转义符号，标记并添加
            result += char;
            isEscaped = true;
            continue;
        }
        
        if (inString) {
            // 在字符串内部
            if (char === stringChar) {
                // 遇到闭合引号，结束字符串
                inString = false;
                result += char;
            } else if (char === '#' && !isEscaped) {
                // URL中的#号需要转义为\u0023
                result += '\\u0023';
            } else if (char === '&' && !isEscaped) {
                // URL中的&号需要转义为\u0026
                result += '\\u0026';
            } else if (char === '?' && !isEscaped) {
                // URL中的?号需要转义为\u003F
                result += '\\u003F';
            } else if (char === '=' && !isEscaped) {
                // URL中的=号需要转义为\u003D
                result += '\\u003D';
            } else if (char === '+' && !isEscaped) {
                // URL中的+号需要转义为\u002B
                result += '\\u002B';
            } else if (char === '%' && !isEscaped) {
                // URL中的%号需要转义为\u0025
                result += '\\u0025';
            } else if (char === '@' && !isEscaped) {
                // @符号转义为\u0040
                result += '\\u0040';
            } else if (char === ':' && !isEscaped) {
                // :符号转义为\u003A
                result += '\\u003A';
            } else if (char === '/' && !isEscaped) {
                // /符号转义为\u002F
                result += '\\u002F';
            } else {
                result += char;
            }
        } else if (char === '"' || char === "'") {
            // 进入字符串模式
            inString = true;
            stringChar = char;
            result += char;
        } else {
            result += char;
        }
    }
    
    return result;
}

// 确保格式化后的JSON底部有足够的空间
function ensureBottomSpaceForJson() {
    // 检查是否存在底部边距
    if ($('#bottom-spacer').length === 0) {
        $('#json-target').append('<div id="bottom-spacer" style="height:40px;"></div>');
    }
    
    // 如果内容很长，确保滚动到可见区域
    if ($('#json-target').height() > $('#right-box').height()) {
        // 这里不强制滚动，让用户自己控制滚动位置
    }
}

// 每次格式化JSON后调用
$('#json-src').keyup(function(){
    // ... existing code ...
    ensureBottomSpaceForJson();
});
</script>
</body>
</html>
